#!/usr/bin/env php
<?php

namespace Adminerng;

use FilesystemIterator;
use Phar;
use Nette\Utils\Finder;

require_once __DIR__ . '/../vendor/autoload.php';

/**
 * TODO create as command
 * TODO add parameters (i.e.: languages - and compile only selected languages)
 * TODO optimize - do not include not needed files
 */
class Compile
{
    private $phar;

    private $appRoot;

    public function run()
    {
        $this->appRoot = realpath(__DIR__ . '/..') . '/';

        $name = 'index';
        $pharFile = $name . '.phar';
        $pharTarget = __DIR__ . '/../build/' . $pharFile;
        $phpTarget = __DIR__ . '/../build/' . $name . '.php';

        $this->phar = new Phar($pharTarget, FilesystemIterator::CURRENT_AS_FILEINFO | FilesystemIterator::KEY_AS_FILENAME, $pharFile);
        $this->phar->startBuffering();
        $this->addFile(__DIR__ . '/../app/bootstrap_live.php', 'app/bootstrap.php');

        $files = Finder::findFiles([
            '*.php',
            '*.phtml',
            '*.neon',
            '*.latte',
            '*.css',
            '*.js',
            '*.eot',
            '*.ttf',
            '*.woff',
            '*.woff2',
        ])->from([
            __DIR__.'/../www/',
            __DIR__.'/../app/Core/',
            __DIR__.'/../app/Drivers/',
            __DIR__.'/../app/Router/',
            __DIR__.'/../app/components/',
            __DIR__.'/../app/config/',
            __DIR__.'/../app/lang/',
            __DIR__.'/../app/presenters/',
            __DIR__.'/../vendor/nette/',
            __DIR__.'/../vendor/tracy/',
            __DIR__.'/../vendor/latte/',
            __DIR__.'/../vendor/lulco/',
            __DIR__.'/../vendor/tomaj/',
            __DIR__.'/../vendor/php-amqplib/',
            __DIR__.'/../vendor/predis/',
            __DIR__.'/../vendor/radekdostal/'
        ])->exclude([
            '.git',
            '.svn',
            'LICENSE',
            'Tests',
            'tests',
            'docs',
            'examples',
        ]);

        foreach ($files as $file) {
            $this->addFile($file);
        }

        $this->addFile(__DIR__ . '/../vendor/autoload.php');
        $this->addFile(__DIR__ . '/../vendor/composer/autoload_classmap.php');
        $this->addFile(__DIR__ . '/../vendor/composer/autoload_files.php');
        $this->addFile(__DIR__ . '/../vendor/composer/autoload_namespaces.php');
        $this->addFile(__DIR__ . '/../vendor/composer/autoload_psr4.php');
        $this->addFile(__DIR__ . '/../vendor/composer/autoload_real.php');
        $this->addFile(__DIR__ . '/../vendor/composer/autoload_static.php');
        $this->addFile(__DIR__ . '/../vendor/composer/ClassLoader.php');

        $this->phar->setStub('<?php
        Phar::mapPhar(\'' . $pharFile . '\');
        require \'phar://' . $pharFile . '/www/index.php\';
        __HALT_COMPILER(); ?>');

        $this->phar->stopBuffering();

        copy($pharTarget, $phpTarget);
    }

    private function addFile($filepath, $pharPath = null)
    {
        if (!file_exists($filepath)) {
            return false;
        }
        if ($pharPath === null) {
            $realPath = realpath($filepath);
            $pharPath = str_replace($this->appRoot, '', $realPath);
        }
        $this->phar->addFromString($pharPath, file_get_contents($filepath));
        return true;
    }
}

$compile = new \Adminerng\Compile();
$compile->run();
